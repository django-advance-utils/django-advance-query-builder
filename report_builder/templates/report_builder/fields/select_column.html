<div id="div_{{ field.auto_id }}" class="form-group row">
    <label for="{{ field.auto_id }}" class="col-form-label col-md-3 col-form-label-sm">
        Display Fields
    </label>

    <div class="col-md-9 input-group-sm">
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <style>
            #{{ field.auto_id }}_selection, #{{ field.auto_id }}_available_fields {
                border: 1px solid #eee;
                width: 100%;
                height: 300px;
                overflow: scroll;
                list-style-type: none;
                padding: 5px 0 0 0;
                float: left;
                margin: 0 10px 0 0;
                color: white;
            }

            #{{ field.auto_id }}_selection li, #{{ field.auto_id }}_available_fields li {
                margin: 0 5px 5px 5px;
                padding: 5px;
                font-size: 1.2em;
                width: 100%;
                color: white;
            }
        </style>



        <div class="row">

            <div class="col-5" id="selection_div">
                <h6><strong>Selection</strong>
                </h6> <input type="text"
                             id="{{ field.auto_id }}_selected_search_input"

                             placeholder="Search selected fields"
                             class="form-control"
                             style="width: 100%!important;">
                <br>
                <ol id="{{ field.auto_id }}_selection" class="connectedSortable ui-sortable ui-droppable"
                    data-empty-message="Drag available fields from the right to this area." style="font-size: 12px">


                </ol>
            </div>

            <div class="col-4" id="{{ field.auto_id }}_available_fields_div">
                <h6><strong>Available
                    Fields</strong>
                </h6> <input
                    type="text" id="{{ field.auto_id }}_field_search_input"

                    placeholder="Search available fields"
                    class="form-control" style="width: 100%px!important;"> <br>
                <ul id="{{ field.auto_id }}_available_fields" class="connectedSortable ui-sortable ui-droppable"
                    style="font-size: 12px">
                </ul>
            </div>


            <div id="{{ field.auto_id }}_keys" class="col-3">

            </div>


        </div>

    </div>


            <script>
            $(function () {
                let selection_fields_id_name = '#{{ field.auto_id }}_selection';
                let available_fields_id_name = '#{{ field.auto_id }}_available_fields';
                let table_field_keys = '#{{ field.auto_id }}_keys';
                let main_field = '#{{ field.auto_id }}';
                let available_fields_data = {};
                let initial = true;

                ajax_helpers.command_functions.report_fields = function (command) {
                    let data = jQuery.parseJSON(command.data);
                    $(selection_fields_id_name).empty();
                    $(available_fields_id_name).empty();
                    $(table_field_keys).empty();
                    available_fields_data = {};
                    $.each(data['fields'], function (key, value) {
                        available_fields_data[value.field] = value;
                        $(available_fields_id_name).append('<li class="ui-state-default"' +
                            'data-origin="' + value.field + '" style="background-color: ' + value.colour + '">' + value.label + '</a></li>');

                    });
                    $.each(data['tables'], function (key, value) {
                        $(table_field_keys).append('<div class="col-sm-12" style=";font-size: 12px;">' +
                            '<i class="fa fa-square fa-2x" style="opacity:1;color: ' + value.colour + '"></i>' +
                            ' <span>' + value.name + '</span> </div>');
                    });
                    if(initial) {
                        load_section();
                        initial = false;
                    } else {
                        $(main_field).val('[]')
                    }
                }

                $(selection_fields_id_name + ', ' + available_fields_id_name).sortable({
                    connectWith: ".connectedSortable",

                    stop: function () {
                        update_selection();
                    }

                }).disableSelection();

                $('#id_report_type').on('change', function (e) {
                    get_fields(this.value);
                });
                $(document).ready(function () {
                    get_fields($('#id_report_type').val());
                });

                function get_fields(report_type_id) {
                    if (report_type_id === '') {
                        $(selection_fields_id_name).empty();
                        $(available_fields_id_name).empty();
                        $(table_field_keys).empty();
                    } else {
                        django_modal.send_inputs({'ajax': 'get_fields'})
                    }
                }


                function update_selection() {
                    let table_fields_selection = [];
                    $(selection_fields_id_name).children().each(function () {
                        let current = $(this);
                        let data_origin = current.attr('data-origin');
                        table_fields_selection.push({
                            'field': data_origin,
                            'title': current.text()
                        })
                    });
                    $(main_field).val(JSON.stringify(table_fields_selection))
                }

                function load_section() {
                    let fields = JSON.parse($(main_field).val())
                    $.each(fields, function (key, value) {
                        let field_data = available_fields_data[value.field];
                        $(selection_fields_id_name).append('<li class="ui-state-default"' +
                            'data-origin="' + value.field + '" style="background-color: ' + field_data.colour + '">' + value.title + '</a></li>');

                    });
                }
                $('#{{ field.auto_id }}_selected_search_input').keyup(function() {
                    search_fields(this.value, selection_fields_id_name);
                })
                $('#{{ field.auto_id }}_field_search_input').keyup(function() {
                    search_fields(this.value, available_fields_id_name);
                })


                function search_fields(searchString, area_id) {
                    searchString = searchString.toUpperCase();
                    $(area_id + " li").each(function (index, value) {
                        let currentName = $(value).text()
                        if (currentName.toUpperCase().indexOf(searchString) > -1) {
                            $(value).show();
                        } else {
                            $(value).hide();
                        }
                    });
                }
            });


        </script>
</div>
<input type="hidden" name="{{ field.name }}" id="{{ field.auto_id }}" value="{% if field.value %}{{ field.value }}{% endif %}">
